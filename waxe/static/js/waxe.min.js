/*! Waxe - v0.1.0 - 2013-11-28
* https://github.com/LeResKP/waxe
* Copyright (c) 2013 Aur√©lien Matouillot; Licensed MIT */
var waxe=waxe||{};!function(a,b){"use strict";var c=function(b,c,d,e,f){f="undefined"==typeof f?!0:f,a.ajax({type:b,url:c,async:f,data:e,dataType:"json",success:function(a){d(a)},error:function(b){var d=b.status+" "+b.statusText+": "+c;a(document).message("error",d)}})};b.ajax={GET:function(a,b,d){c("GET",a,b,null,d)},POST:function(a,b,d,e){c("POST",a,d,b,e)}}}(jQuery,waxe);var waxe=waxe||{};!function(a,b){"use strict";var c=function(b){b.preventDefault(),window.history.pushState({json_url:a(this).data("href")},a(this).text(),a(this).attr("href")),waxe.dom.load(a(this).data("href"))};b.dom={addPushStateOnLinks:function(a){a.find("a[data-href]").click(c)},update:function(b){if(a(document).scrollTop(0),b.error_msg)return a(document).message("error",b.error_msg),void 0;if("content"in b){var c=a(".content");c.html(b.content),waxe.dom.addPushStateOnLinks(c),waxe.form.load(b.jstree_data),waxe.versioning.init(),a(document).message("info","Loaded!")}var d=a(".breadcrumb");"breadcrumb"in b?(d.html(b.breadcrumb),waxe.dom.addPushStateOnLinks(d)):d.html(""),"jstree_data"in b||a("body").data("layout").hide("east")},load:function(b){a(document).message("info","Loading...",{autohide:!1}),waxe.ajax.GET(b,function(a){waxe.dom.update(a)})}},a(document).ready(function(){waxe.dom.addPushStateOnLinks(a(".content,.breadcrumb,.navbar .dropdown-versioning"))})}(jQuery,waxe);var waxe=waxe||{};!function(a){"use strict";var b=function(a){this.selector="form#xmltool-form",this.filename_selector="#_xml_filename",this.$element=null,this.status=null,this.$filename=null,this.auto_save_interval=null,this.auto_save_time=6e4,this.load(a)};b.STATUS_UPDATED="updated",b.prototype.load=function(b){var c=this;this.$element=null,this.status=null,this.$filename=null;var d=a(this.selector);return clearInterval(this.auto_save_interval),d.length?(this.$element=d,this.$filename=d.find(this.filename_selector),this.filename=this.$filename.val(),this.$element.xmltool({add_element_url:this.$element.data("add-href"),comment_modal_url:this.$element.data("comment-href"),jstreeSelector:"#tree",jstreeData:b,message:function(){var b=a(document);b.message.apply(b,arguments)},treeContainerSelector:".ui-layout-center"}).submit(a.proxy(this.save,this)).on("loadedJstree",function(){a("body").data("layout").show("east")}),this.$element.on("field_change.xmltool",function(){c.status=c.STATUS_UPDATED}),this.auto_save(),!0):!1},b.prototype.setFilename=function(a){return this.$element?(this.$filename.val(a),this.filename=a,!0):!1},b.prototype.save=function(b){if(!this.$element)return!1;b.preventDefault();var c=this,d=this.$element.serialize();waxe.ajax.POST(this.$element.data("href"),d,function(b){b.status?(c.status=null,a(document).message("success","Saved"),a(".breadcrumb").html(b.breadcrumb)):a(document).message("error",b.error_msg)})},b.prototype.auto_save=function(){var a=this,b=function(){a.status===a.STATUS_UPDATED&&(a.$element.submit(),a.status=null)};this.filename&&(this.auto_save_interval=setInterval(b,this.auto_save_time))},a(document).ready(function(){var a=null;"undefined"!=typeof jstree_data&&(a=jstree_data),waxe.form=new b(a)})}(jQuery,waxe);var waxe=waxe||{};!function(a,b){"use strict";b.layout={init:function(){a("body").layout({applyDemoStyles:!0,north:{applyDefaultStyles:!1,closable:!1,resizable:!1,pane_spacing:0,size:55},east:{initHidden:!0,onresize_end:function(){var b=a("#tree");b.height(b.parent().parent().height())}}})}},a(document).ready(function(){waxe.layout.init()})}(jQuery,waxe);var waxe=waxe||{};!function(a){"use strict";var b=function(a){this.init(a)};b.prototype.init=function(b){this.$element=a(b),this.$elements={"new":this.$element.find(".new"),open:this.$element.find(".open"),saveas:this.$element.find(".saveas"),save:this.$element.find(".save")};for(var c in this.$elements)this["init_"+c]()},b.prototype._setNewModalEvents=function(b){b.find(".dtd-urls").on("change",function(){var c=a(this).val();if(c){var d=a(this).data("href");waxe.ajax.GET(d+"?dtd_url="+c,function(c){var d=b.find(".dtd-tags");d.html("");for(var e in c.tags){var f=c.tags[e];d.append(a("<option>").attr("value",f).html(f))}})}}),b.find(".submit").click(function(c){c.preventDefault();var d=a(this).data("href"),e=b.find(".dtd-urls").val(),f=b.find(".dtd-tags").val();e&&f&&(d=d+"?dtd_url="+e+"&dtd_tag="+f,waxe.dom.load(d),b.modal("hide"))})},b.prototype.init_new=function(){var b=this;this.$elements.new.click(function(c){c.preventDefault();var d=a(this);if(d.data("modal"))d.data("modal").modal("show");else{var e=d.data("href");waxe.ajax.GET(e,function(c){var e=a(c.content);b._setNewModalEvents(e),d.data("modal",e),e.modal()})}})},b.prototype.init_open=function(){this.$elements.open.filebrowser({url:this.$elements.open.data("fb-href"),title:"Open file"}).bind("select",function(a){waxe.dom.load(a.href)})},b.prototype.init_saveas=function(){var b=this;this.$elements.saveas.filebrowser({url:this.$elements.saveas.data("fb-href"),text:{title:"Save file",submit:"Save"},type:"save"}).bind("before_open",function(a){waxe.form.$element||a.preventDefault()}).bind("select",function(a){waxe.form.setFilename(a.href),waxe.form.$element.submit()}).bind("create_folder",function(c){var d=b.$elements.saveas.data("fb-folder-href")+"?path="+c.path;waxe.ajax.GET(d,function(b){b.status===!1&&(c.preventDefault(),a(document).message("error",b.error_msg))},!1)})},b.prototype.init_save=function(){var a=this;this.$elements.save.click(function(b){b.preventDefault(),waxe.form.filename?waxe.form.$element.submit():a.$elements.saveas.trigger("click")})},b.prototype.destroy=function(){for(var a in this.$elements)this.$elements[a].unbind("click");var b=this.$elements.open.data("filebrowser");b.$element.unbind("select").unbind("create_folder"),this.$elements.open.removeData("filebrowser"),b=this.$elements.saveas.data("filebrowser"),b.$element.unbind("select").unbind("create_folder"),this.$elements.saveas.removeData("filebrowser")},a(document).ready(function(){new b(a(".navbar"))}),waxe.NavBar=b}(jQuery),function(a){"use strict";a.fn.message.defaults.css.position="fixed",a.fn.message.defaults.css["z-index"]=2e3,a.fn.message.defaults.template.message='<div class="alert">      <button type="button" class="close">&times;</button>      <span class="text"/>    </div>',a.fn.message.defaults.extra_class={info:"alert-info",success:"alert-success",error:"alert-danger"},a.fn.message.defaults.selector.close_btn=".close",a.fn.filebrowser.defaults.template.nav_file='<li><i class="icon-file"></i></li>',a.fn.filebrowser.defaults.template.nav_folder='<li><i class="icon-folder-close"></i></li>'}(jQuery);var waxe=waxe||{};!function(a,b){"use strict";b.versioning={init:function(){a("a.select-all").click(function(b){b.preventDefault(),a(this).parents("form").find('input[type="checkbox"]').attr("checked",!0)}),a("a.select-none").click(function(b){b.preventDefault(),a(this).parents("form").find('input[type="checkbox"]').removeAttr("checked")}),a("table.diff").next("input.diff-submit").length&&a("table.diff td.diff_to").attr("contenteditable","true"),a("form.diff").submit(function(b){var c=a(this).serialize();""===c&&b.preventDefault()}),a("form.multiple-diff-submit").submit(function(b){a(document).message("info","Loading...",{autohide:!1}),b.preventDefault();var c=a(this).data("action");a("table.diff").each(function(){a(this).prev("textarea").val("");var b="";a(this).find("td.diff_to pre").each(function(){a(this).contents().each(function(){b+=a(this).text()}),b+="\n"}),a(this).prev("textarea").val(b)});var d=a(this).serialize();d+="&commit=true",a.ajax({type:"POST",url:c,data:d,dataType:"json",success:function(b){if(b.status){a(document).message("success","Saved");var c=a(b.content);c.find(".submit").click(function(){var a=c.find("textarea").val();""!==a&&(d=d+"&msg="+a,waxe.versioning.commit(d),c.modal("hide"))}),c.modal("show")}else a(document).message("error",b.error_msg)},error:function(b){var c=b.status+" "+b.statusText+": "+"/update.json";a(document).message("error",c)}})}),a("form.multiple-diff").submit(function(b){a(document).message("info","Loading...",{autohide:!1}),b.preventDefault();var c=a(this).data("action"),d=a(this).serialize();a.ajax({type:"POST",url:c,data:d,dataType:"json",success:function(a){waxe.dom.update(a)},error:function(b){var c=b.status+" "+b.statusText+": "+"/update.json";a(document).message("error",c)}})})},commit:function(b){a(document).message("info","Commit in progress...",{autohide:!1}),a.ajax({type:"POST",url:"/versioning/commit.json",data:b,dataType:"json",success:function(b){b.status?a(document).message("success","Commit done"):a(document).message("error",b.error_msg)},error:function(b){var c=b.status+" "+b.statusText+": "+"/versioning/commit.json";a(document).message("error",c)}})}},a(document).ready(function(){waxe.versioning.init()})}(jQuery,waxe);var waxe=waxe||{};!function(){"use strict";window.onpopstate=function(a){null!==a.state&&waxe.dom.load(a.state.json_url)},window.onbeforeunload=function(a){if(waxe.form.status===waxe.form.STATUS_UPDATED){a=a||window.event;var b="The file has been updated, are you sure you want to exit?";return a&&(a.returnValue=b),b}}}(jQuery);